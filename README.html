<?xml version="1.0" encoding="utf-8"?>
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Mini-CI</title>
<!-- 2014-12-22 Mon 11:31 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Andrew Phillips" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Mini-CI</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Introduction</a></li>
<li><a href="#sec-2">2. Features</a></li>
<li><a href="#sec-3">3. Installation</a>
<ul>
<li><a href="#sec-3-1">3.1. Ubuntu PPA</a></li>
<li><a href="#sec-3-2">3.2. From Source</a></li>
</ul>
</li>
<li><a href="#sec-4">4. Usage</a></li>
<li><a href="#sec-5">5. Configuration</a></li>
<li><a href="#sec-6">6. Contents of a Job Directory</a>
<ul>
<li><a href="#sec-6-1">6.1. <code>config</code></a></li>
<li><a href="#sec-6-2">6.2. <code>tasks.d</code></a></li>
</ul>
</li>
<li><a href="#sec-7">7. Examples</a>
<ul>
<li><a href="#sec-7-1">7.1. Mini-CI Job Directory</a></li>
<li><a href="#sec-7-2">7.2. Starting the Mini-CI Daemon as a User</a></li>
<li><a href="#sec-7-3">7.3. Notifying a Mini-CI Daemon from GIT</a></li>
</ul>
</li>
<li><a href="#sec-8">8. Plugin API</a>
<ul>
<li><a href="#sec-8-1">8.1. Hooks</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
Mini-CI is a small daemon to perform continuous integration (CI) for a single repository/project.  Most other CI software is complicated to setup and use due to feature bloat and hiding what is going on underneath with GUIs.  If you know how to build your project from the command line, setting up Mini-CI should be easy.
</p>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Features</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>NO web interface!
<ul class="org-ul">
<li>Configuration is done with a small config file and shell scripts.
</li>
<li>Daemon controlled through a command.
</li>
</ul>
</li>
<li>NO user authentication!
<ul class="org-ul">
<li>Unix already has multiple users, use groups or make a shared account.
</li>
</ul>
</li>
<li>NO support for multiple projects!
<ul class="org-ul">
<li>You can run it more than once&#x2026;
</li>
</ul>
</li>
<li>Plugin system
</li>
<li>Low resource requirements.
<ul class="org-ul">
<li>Just a small bash script.
</li>
</ul>
</li>
<li>Can monitor any repository and use any build system.
<ul class="org-ul">
<li>The only limits are the scripts you provide.
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Installation</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Ubuntu PPA</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>Stable release: <a href="https://launchpad.net/~theasp/+archive/ubuntu/mini-ci">https://launchpad.net/~theasp/+archive/ubuntu/mini-ci</a>
</li>
<li>Snapshot release: <a href="https://launchpad.net/~theasp/+archive/ubuntu/mini-ci-snapshot">https://launchpad.net/~theasp/+archive/ubuntu/mini-ci-snapshot</a>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> From Source</h3>
<div class="outline-text-3" id="text-3-2">
<p>
To install into <code>/usr/local</code>:
</p>
<div class="org-src-container">

<pre class="src src-sh">make clean install
</pre>
</div>

<p>
To install into your home directory (<code>~/opt/mini-ci</code>):
</p>
<div class="org-src-container">

<pre class="src src-sh">make clean install <span style="color: #eedd82;">prefix</span>=~/opt/mini-ci
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Usage</h2>
<div class="outline-text-2" id="text-4">
<p>
From the output of <code>mini-ci --help</code>:
</p>
<pre class="example">
Usage: mini-ci [option ...] [command ...]

Options:
  -d|--job-dir &lt;dir&gt;       directory for job
  -c|--config-file &lt;file&gt;  config file to use, relative to job-dir
  -m|--message [timeout]   send commands to running daemon, then exit
  -o|--oknodo              exit quietly if already running
  -D|--debug               log debugging information
  -F|--foreground          do not become a daemon, run in foreground
  -h|--help                show usage information and exit

Commands:
  status  log the current status
  poll    poll the source code repository for updates, queue update if
          updates are available
  update  update the source code repository, queue tasks if updates are made
  tasks   run the tasks in the tasks directory
  clean   remove the work directory
  abort   abort the currently running command
  quit|shutdown
          shutdown the daemon, aborting any running command
  reload  reread the config file, aborting any running command

Commands given while not in message mode will be queued.  For instance
the following command will have a repository polled for updates (which
will trigger update and tasks if required) then quit.
  mini-ci -d &lt;dir&gt; -F poll quit
</pre>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Configuration</h2>
<div class="outline-text-2" id="text-5">
<p>
You can configure a Mini-CI job by copying the <code>skeleton</code> directory somewhere and then editing where required.  This directory is referred to has the "job directory".  The skeleton contains the file <code>config</code> and the directory <code>tasks.d</code>, see their description later.  Once you have the configuration in place you can try it by running <code>mini-ci -F</code> in the directory you created, which will run Mini-CI in the foreground.
</p>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Contents of a Job Directory</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li><code>config</code>: The configuration file for the job.
</li>
<li><code>tasks.d</code>: Contains all the tasks that would be executed during a build of your repository
</li>
<li><code>builds</code>: The builds directory contains the output of each build of a job in numbered directories.
</li>
<li><code>workspace</code>: The directory your repository is checked out into, and built in.
</li>
<li><code>mini-ci.log</code>: The main log for Mini-CI.
</li>
<li><code>poll.log</code>: The log for the last poll operation.
</li>
<li><code>tasks.log</code>: The log for the last tasks operation.
</li>
<li><code>update.log</code>: The log for the last update operation.
</li>
<li><code>control.fifo</code>: This is a FIFO used to communicate with the Mini-CI daemon.
</li>
</ul>
</div>

<div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> <code>config</code></h3>
<div class="outline-text-3" id="text-6-1">
<p>
The <code>config</code> file is a shell script that is sourced when Mini-CI is started which contains the configuration to use for your job.  Every option should have sane defaults, so feel free to only have the entries you wish to use.  If you want a variable exported during your job, for instance <code>PATH</code>, this would also be a good place to do so.
</p>

<p>
The <code>config</code> file in <code>skeleton</code> is:
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">All paths are relative to the job directory.</span>

<span style="color: #ff7f24;">####################</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">Main Configuration</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">JOB_NAME: The name of the job.  Defaults to "$(</span><span style="color: #fa8072;">basename</span><span style="color: #ff7f24;"> $JOB_DIR)"</span>
<span style="color: #eedd82;">JOB_NAME</span>=<span style="color: #ffa07a;">"$(</span><span style="color: #fa8072;">basename</span><span style="color: #ffa07a;"> $JOB_DIR)"</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">REPO_PLUGIN: This is the name of a plugin that will handle</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">repository actions.  The following plugins come with Mini-CI:</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">- git</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">- svn</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">- external</span>
<span style="color: #eedd82;">REPO_PLUGIN</span>=<span style="color: #ffa07a;">"&lt;plugin&gt;"</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">POLL_FREQ: If this is set to a number greater than zero, it will poll the</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">repository using the repo-handler every this many seconds, starting</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">at startup.  To have a more complicated scheme, use cron.</span>
<span style="color: #eedd82;">POLL_FREQ</span>=600

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">WORKSPACE: The directory where the repository will be checked out</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">into, and where tasks are launched.  Defaults to "./workspace".</span>
<span style="color: #eedd82;">WORKSPACE</span>=<span style="color: #ffa07a;">"./workspace"</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">TASKS_DIR: The directory which holds the tasks to be performed on</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">the checked out repository.  Defaults to "./tasks.d"</span>
<span style="color: #eedd82;">TASKS_DIR</span>=<span style="color: #ffa07a;">"./tasks.d"</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">BUILDS_DIR: The directory which stores the output of each build when</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">tasks run.  Defaults to "./builds".</span>
<span style="color: #eedd82;">BUILDS_DIR</span>=<span style="color: #ffa07a;">"./builds"</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">CONTROL_FIFO: The fifo that mini-ci will read to accept commands.</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">Defaults to "./control.fifo".</span>
<span style="color: #eedd82;">CONTROL_FIFO</span>=<span style="color: #ffa07a;">"./control.fifo"</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">PID_FILE: The file containing the process ID for mini-ci.  Defaults</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">to "./minici.pid".</span>
<span style="color: #eedd82;">PID_FILE</span>=<span style="color: #ffa07a;">"./mini-ci.pid"</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">STATUS_FILE: A file where status information is kept.  Defaults to</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">"./status".</span>
<span style="color: #eedd82;">STATUS_FILE</span>=<span style="color: #ffa07a;">"./status"</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">POLL_LOG: Name of the poll log.  Defaults to "./poll.log".</span>
<span style="color: #eedd82;">POLL_LOG</span>=<span style="color: #ffa07a;">"./poll.log"</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">UPDATE_LOG: Name of the update log.  Defaults to "./update.log".</span>
<span style="color: #eedd82;">UPDATE_LOG</span>=<span style="color: #ffa07a;">"./update.log"</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">TASKS_LOG: Name of the tasks log.  Defaults to "./tasks.log".</span>
<span style="color: #eedd82;">TASKS_LOG</span>=<span style="color: #ffa07a;">"./tasks.log"</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">MINICI_LOG: Name of the mini-ci log.  Defaults to "./mini-ci.log".</span>
<span style="color: #eedd82;">MINICI_LOG</span>=<span style="color: #ffa07a;">"./mini-ci.log"</span>

<span style="color: #ff7f24;">####################</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">Plugin Configuration</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">GIT_URL: The URL to the repository.  Fetching the URL must not ask</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">for a username or password.  Use ~/.netrc or ssh keys for remote</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">repositories.</span>
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">GIT_URL="&lt;url&gt;"</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">SVN_URL: The URL to the repository.  Fetching the URL must not ask</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">for a username or password.  Use ~/.netrc or ssh keys for remote</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">repositories.</span>
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">SVN_URL="&lt;url&gt;"</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">EMAIL_NOTIFY: A space and/or comma separated list of conditions to</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">notify about.  Valid options are "NEVER", "ERROR", "OK", "UNKNOWN",</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">"RECOVER" (when a state changes from "ERROR" or "UNKNOWN" to "OK")</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">and "NEWPROB" (when a state changes from "OK" to "ERROR" or</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">"UNKNOWN").  Defaults to "NEWPROB, RECOVER".</span>
<span style="color: #eedd82;">EMAIL_NOTIFY</span>=<span style="color: #ffa07a;">"NEWPROB, RECOVER"</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">EMAIL_ADDRESS: A space and/or comma separated list of addresses to</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">email.  If not specified, will be sent to the user that is running</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">the script.  Defaults to "".</span>
<span style="color: #eedd82;">EMAIL_ADDRESS</span>=<span style="color: #ffa07a;">""</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">EMAIL_SUBJECT: The subject to have for notification emails.</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">Defaults to "Mini-CI Notification - $JOB_NAME".</span>
<span style="color: #eedd82;">EMAIL_SUBJECT</span>=<span style="color: #ffa07a;">"Mini-CI Notification - $JOB_NAME"</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">BUILD_ARCHIVE_WORKSPACE: When set to "yes" will copy the workspace into</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">the $BUILDS_DIR/$BUILD_NUM/workspace.  Defaults to "no".</span>
<span style="color: #eedd82;">BUILD_ARCHIVE_WORKSPACE</span>=<span style="color: #ffa07a;">""</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">BUILD_KEEP: If this is set to a number greater than zero, only this</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">many build log directories will be kept.  Defaults to "0".</span>
<span style="color: #eedd82;">BUILD_KEEP</span>=0
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2"><span class="section-number-3">6.2</span> <code>tasks.d</code></h3>
<div class="outline-text-3" id="text-6-2">
<p>
The <code>tasks.d</code> directory contains all the tasks that would be executed during a build of your repository.  The <code>skeleton</code> contains a few examples.  Each script must match the regular expression <code>^[a-zA-Z0-9_-]+$</code> and will be ran in sort order, therefore it is recommended that each script be named in the form <code>&lt;nnn&gt;-&lt;description_of_task&gt;</code>.  If a script exits with a return code that is not zero, it is considered a build error and no further scripts are executed.
</p>

<p>
Mini-CI exports the following variables:
</p>
<ul class="org-ul">
<li><code>MINI_CI_DIR</code>: The data directory for Mini-CI
</li>
<li><code>MINI_CI_VER</code>: The version of the Mini-CI running
</li>
<li><code>BUILD_DISPLAY_NAME</code>: The build number with "#" prepended.  i.e. "#123"
</li>
<li><code>BUILD_ID</code>: The date and time the build started in the following format:  <code>%Y-%m-%d_%H-%M-%S</code>
</li>
<li><code>BUILD_OUTPUT_DIR</code>: The directory used for storage for the current build
</li>
<li><code>BUILD_NUMBER</code>: The current build number.
</li>
<li><code>BUILD_TAG</code>: A string of the form: <code>mini-ci-${JOB_NAME}-${JOB_NUMBER}</code>
</li>
<li><code>JOB_DIR</code>: The directory where the job is stored
</li>
<li><code>JOB_NAME</code>: Name of the the job
</li>
<li><code>WORKSPACE</code>: The current workspace directory
</li>
<li><code>GIT_URL</code>: The URL of the GIT repository
</li>
<li><code>SVN_URL</code>: The URL of the Subversion repository
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Examples</h2>
<div class="outline-text-2" id="text-7">
</div><div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1"><span class="section-number-3">7.1</span> Mini-CI Job Directory</h3>
<div class="outline-text-3" id="text-7-1">
<p>
This example will configure to monitor Mini-CI's GIT repository and run tests whenever it's updated.
</p>

<p>
Create and enter a directory called <code>mini-ci-job</code>, then place the following in <code>config</code>:
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #eedd82;">REPO_PLGUIN</span>=<span style="color: #ffa07a;">"git"</span>
<span style="color: #eedd82;">GIT_URL</span>=<span style="color: #ffa07a;">"https://github.com/theasp/mini-ci"</span>
<span style="color: #eedd82;">POLL_FREQ</span>=600
</pre>
</div>

<p>
This configuration will use the GIT repository handler with the URL to the Mini-CI repository, and then poll it every 10 minutes.
</p>

<p>
Create the directory <code>tasks.d</code>, then place the following file in <code>tasks.d/100-make</code>
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">!/bin/</span><span style="color: #00ffff;">sh</span>

<span style="color: #b0c4de;">set</span> -ex

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">Override the prefix to install into ~/opt/mini-ci</span>
make <span style="color: #eedd82;">prefix</span>=~/opt/mini-ci
</pre>
</div>

<p>
Place the following file in <code>tasks.d/500-run_tests</code>:
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">!/bin/</span><span style="color: #00ffff;">sh</span>
make test
</pre>
</div>

<p>
Run <code>chmod +x tasks.d/500-run_tests</code> to make the script executable.  Now when you run <code>mini-ci -F</code> in the job directory you will get:
</p>

<pre class="example">
2014-12-18 17:20:03 mini-ci/7145 Starting up
2014-12-18 17:20:05 mini-ci/7369 Missing workdir, doing update instead
2014-12-18 17:20:05 mini-ci/7145 Updating workspace
2014-12-18 17:20:06 mini-ci/7145 Update finished sucessfully, queuing tasks
2014-12-18 17:20:06 mini-ci/7145 Mailing update notification to user due to RECOVER (New:OK Old:UNKNOWN)
2014-12-18 17:20:06 mini-ci/7145 Mailing poll notification to user due to RECOVER (New:OK Old:UNKNOWN)
2014-12-18 17:20:07 mini-ci/7145 Starting tasks as run number 1
2014-12-18 17:20:07 mini-ci/7145 Tasks finished sucessfully, run number 1
2014-12-18 17:20:07 mini-ci/7145 Mailing tasks notification to user due to RECOVER (New:OK Old:UNKNOWN)
</pre>

<p>
Mini-CI started in foreground mode, downloaded the repository, then ran all the tasks in the <code>tasks.d</code> directory.  Notice that it also sent 3 mail notifications due to update, poll and tasks transitioning from <code>UNKNOWN</code> to <code>RECOVER</code>.  The default email settings will only send mail when they change state.  The process is still running and will check the repository for changes every 10 minutes.
</p>

<p>
You can stop the daemon by pressing <code>ctrl-c</code>, or by running <code>mini-ci -m quit</code> in the job directory in another shell.
</p>
</div>
</div>

<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2"><span class="section-number-3">7.2</span> Starting the Mini-CI Daemon as a User</h3>
<div class="outline-text-3" id="text-7-2">
<p>
The easiest way to run Mini-CI as a user is to have <code>cron</code> start it.  For instance, the following crontab will start Mini-CI every 10 minutes, and if it is already running for that job directory it will exit quietly:
</p>
<pre class="example">
*/10 * * * * mini-ci --oknodo -d ~/some-mini-ci-job-directory
</pre>

<p>
Mini-CI will run in the background doing it's thing whenever it needs to.
</p>
</div>
</div>

<div id="outline-container-sec-7-3" class="outline-3">
<h3 id="sec-7-3"><span class="section-number-3">7.3</span> Notifying a Mini-CI Daemon from GIT</h3>
<div class="outline-text-3" id="text-7-3">
<p>
You can have git notify Mini-CI upon every push to a repository, which makes polling the repository unnecessary.  Put this in <code>hooks/post-update</code> in your git repository directory (or <code>.git/hooks/post-update</code> if you aren't using a bare repository), and it will send a message to Mini-CI to do an update.
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">!/bin/</span><span style="color: #00ffff;">sh</span>

<span style="color: #b0c4de;">set</span> -e
mini-ci -d ~/some-mini-ci-job-directory -m update
</pre>
</div>

<p>
You can easily change the above script to SSH to another system, or user.
</p>
</div>
</div>
</div>
<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Plugin API</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1"><span class="section-number-3">8.1</span> Hooks</h3>
<div class="outline-text-3" id="text-8-1">
<p>
Your plugin can provide functions using the following names:
</p>
<ul class="org-ul">
<li><code>on_abort_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_abort_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_acquire_lock_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_acquire_lock_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_clean_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_clean_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_load_config_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_load_config_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_notify_status_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_notify_status_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_poll_finish_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_poll_finish_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_poll_start_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_poll_start_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_process_queue_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_process_queue_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_queue_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_queue_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_quit_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_quit_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_read_commands_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_read_commands_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_read_status_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_read_status_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_reload_config_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_reload_config_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_run_cmd_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_run_cmd_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_run_tasks_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_run_tasks_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_schedule_poll_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_schedule_poll_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_send_message_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_send_message_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_status_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_status_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_tasks_finish_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_tasks_finish_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_tasks_start_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_tasks_start_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_update_finish_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_update_finish_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_update_start_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_update_start_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_update_status_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_update_status_pre_&lt;plugin_name&gt;</code>
</li>
<li><code>on_write_status_post_&lt;plugin_name&gt;</code>
</li>
<li><code>on_write_status_pre_&lt;plugin_name&gt;</code>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Andrew Phillips &lt;<a href="mailto:theasp@gmail.com">theasp@gmail.com</a>&gt;</p>
<p class="date">Date: 2014-12-22 Mon 11:31</p>
</div>
</body>
</html>
